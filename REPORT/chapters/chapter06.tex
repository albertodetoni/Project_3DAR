%!TeX root = ../main.tex
\newpage \section{MATLAB Code}

\begin{lstlisting}[basicstyle=\scriptsize,]
%% STILL

clear all;
close all;
clc;


files = dir('Wheel_still_2020\*.txt');

datasets=[];
for i=1:length(files)
    
    data=importdata(strcat(files(i).folder, '\', files(i).name));
    if i>2 && length(data(:,1))<length(datasets(:,i-1))
        datasets(length(data(:,1))+1:length(datasets(:,i-1)),:)=[];
    end    
    datasets(:,i)=data(:,1);

    clear data;
end
clear files i;

%%%%%%%%%%%%%%%%%%%%%%%%
        T=15; %us
%%%%%%%%%%%%%%%%%%%%%%%%


tags=datasets.*81e-12*1e6; %tags in us (microseconds)

clicks=tags(:,1);
for i=2:10
    clicks=[clicks; tags(2:length(tags(:,i)),i)+clicks(length(clicks))];
end
tags=clicks; clear clicks i;



m=discretize(tags,0:T:max(tags));
figure('Renderer', 'painters', 'Position', [500 300 900 600]); 
hold on; grid on;

    [GC,GR] = groupcounts(m);
    GC(length(GC)+1:max(GR))=0; %zero padding

    [vals_y,~]=histcounts(GC, 'BinMethod', 'Integers');
    
    vals_x=0:length(vals_y)-1; 
    
    N=sum(vals_y);
    
    vals_x=vals_x';
    vals_y=vals_y';
    
    stem(vals_x,vals_y/N, 'filled')
    
    lam=length(tags)/tags(length(tags))*T;


n=0:length(vals_x); n=n'; 
poisson=exp(-lam).*(lam.^n)./factorial(n);

plot(n,poisson, 'r', 'LineWidth', 1.5)

xlim([0 length(vals_x)])
title(strcat('Wheel still - T=', string(T), ...
    '\mus - empirical distribution'), 'FontSize', 15)
ylabel('number of occurrences normalized', 'FontSize', 15);
xlabel('number of photons in the interval T', 'FontSize', 15);

pbaspect([1.5 1 1])
clear i j initial final datasets;


%%%%%%%% MOMENTA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

mu=lam;
m1P=sum((n.*exp(-mu).*mu.^n)./(factorial(n)));
diff1P=m1P-mu;
m2P=sum(((n-mu).^2.*exp(-mu).*mu.^n)./(factorial(n)));
diff2P=m2P-mu;
m3P=sum(((n-mu).^3.*exp(-mu).*mu.^n)./(factorial(n)));
diff3P=m3P-mu;
m4P=sum(((n-mu).^4.*exp(-mu).*mu.^n)./(factorial(n)));
diff4P=m4P-(mu+3*mu^2);

errorbar(n,poisson,...
    std(vals_y/N-poisson(1:length(vals_y)))*ones(size(poisson)))

legend('occurrences',strcat('Poisson distrib. (\lambda=', string(lam),...
    ')'), 'std dev', 'FontSize', 15);

%% SPINNING

clearvars -except T;
clc;


files = dir('Wheel_spinning_2020\*.txt');

datasets=[];
for i=1:length(files)
    
    data=importdata(strcat(files(i).folder, '\', files(i).name));
    if i>2 && length(data(:,1))<length(datasets(:,i-1))
        datasets(length(data(:,1))+1:length(datasets(:,i-1)),:)=[];
    end    
    datasets(:,i)=data(:,1);

    clear data;
end
clear files i;

tags=datasets.*81e-12*1e6; %tags in us (microseconds)

clicks=tags(:,1);
for i=2:10
    clicks=[clicks; tags(2:length(tags(:,i)),i)+clicks(length(clicks))];
end
tags=clicks; clear clicks i;

m=discretize(tags,0:T:max(tags));
figure('Renderer', 'painters', 'Position', [500 300 900 600]);
hold on; grid on;

    [GC,GR] = groupcounts(m);
    GC(length(GC)+1:max(GR))=0; %zero padding


    [vals_y,~]=histcounts(GC, 'BinMethod', 'Integers');
    
    N=sum(vals_y);
    
    vals_x=0:length(vals_y)-1; 
    
    vals_x=vals_x';
    vals_y=vals_y';
    
    stem(vals_x,vals_y/N, 'filled')
           
     lam=length(tags)/tags(length(tags))*T;

n=0:length(vals_x); n=n';
BE=(1/(lam+1)).*(lam/(lam+1)).^n;

plot(n,BE, 'r', 'LineWidth', 1.5)

title(strcat('Wheel spinning - T=', string(T), ...
    '\mus - empirical distribution'), 'FontSize', 15)
ylabel('number of occurrences normalized', 'FontSize', 15);
xlabel('number of photons in the interval T', 'FontSize', 15); 
xlim([0 30]); ylim([-inf inf]);

pbaspect([1.5 1 1])
clear i j initial final datasets h;

%%%%%%%% MOMENTA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

mu=lam;
m1BE=sum(n.*1./(1+mu).*(mu./(1+mu)).^n);
diff1BE=m1BE-mu;
m2BE=sum((n-mu).^2.*1./(1+mu).*(mu./(1+mu)).^n);
diff2BE=m2BE-(mu+mu^2);
m3BE=sum((n-mu).^3.*1./(1+mu).*(mu./(1+mu)).^n);
diff3BE=m3BE-(mu+3*mu^2+2*mu^3);
m4BE=sum((n-mu).^4.*1./(1+mu).*(mu./(1+mu)).^n);
diff4BE=m4BE-(mu + 10*mu^2 + 18*mu^3 + 9*mu^4);

errorbar(n,BE,std(vals_y/N-BE(1:length(vals_y)))*ones(size(BE)))

legend('occurrences',strcat('Bose-Einstein distrib. (\lambda=', ...
    string(lam), ')'), 'std dev', 'FontSize', 15)
\end{lstlisting}